<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>VOIP Settings</title>
  <script src="/homey.js" data-origin="settings"></script>
  <style>
    body { font-family: sans-serif; margin: 20px; }
    label { display: block; margin-top: 10px; }
    input { width: 100%; box-sizing: border-box; }
    button { margin-top: 20px; }
  </style>
</head>
<body>
  <h1>SIP Settings</h1>
  <form id="settings-form">
    <label>SIP Domain/Registrar
      <input id="sip_domain" type="text" />
    </label>
    <label>SIP Proxy/Request-URI host (optional)
      <input id="sip_proxy" type="text" />
    </label>
    <label>Username
      <input id="username" type="text" />
    </label>
    <label>Authentication ID (optional)
      <input id="auth_id" type="text" />
    </label>
    <label>Password
      <input id="password" type="password" />
    </label>
    <label>Realm (optional)
      <input id="realm" type="text" />
    </label>
    <label>Display name (From)
      <input id="display_name" type="text" />
    </label>
    <label>From user
      <input id="from_user" type="text" />
    </label>
    <label>Local IP (Homey)
      <input id="local_ip" type="text" />
    </label>
    <label>SIP Transport
      <select id="sip_transport">
        <option value="UDP">UDP</option>
        <option value="TCP">TCP</option>
      </select>
    </label>
    <label>Local SIP port
      <input id="local_sip_port" type="number" />
    </label>
    <label>Local RTP port
      <input id="local_rtp_port" type="number" />
    </label>
    <label>Codec
      <select id="codec">
        <option value="AUTO">AUTO (prefer PCMA)</option>
        <option value="PCMU">PCMU (G711u)</option>
        <option value="PCMA">PCMA (G711a)</option>
        <option value="G722">G722</option>
      </select>
    </label>
    <label>REGISTER Expires (s)
      <input id="expires_sec" type="number" />
    </label>
    <label>Invite timeout (s)
      <input id="invite_timeout" type="number" />
    </label>
    <label>STUN server (optional)
      <input id="stun_server" type="text" />
    </label>
    <label>STUN port
      <input id="stun_port" type="number" />
    </label>
    <label>Cache days
      <input id="cache_days" type="number" />
    </label>
    <button type="submit">Save</button>
  </form>
  <script>
    function onHomeyReady(Homey) {
      const fields = ['sip_domain','sip_proxy','username','auth_id','password','realm','display_name','from_user','local_ip','sip_transport','local_sip_port','local_rtp_port','codec','expires_sec','invite_timeout','stun_server','stun_port','cache_days'];
      const defaults = {
        sip_transport: 'UDP',
        codec: 'AUTO',
        stun_server: 'stun.l.google.com',
        stun_port: 19302,
        cache_days: 3
      };
      fields.forEach(key => {
        Homey.get(key, (err, value) => {
          if (!err && document.getElementById(key)) {
            const v = value !== undefined && value !== null && value !== '' ? value : (defaults[key] || '');
            document.getElementById(key).value = v;
          }
        });
      });
      document.getElementById('settings-form').addEventListener('submit', e => {
        e.preventDefault();
        fields.forEach(key => {
          const input = document.getElementById(key);
          let val = input.value;
          if (input.type === 'number') {
            val = Number(val);
            if (isNaN(val)) val = 0;
          }
          Homey.set(key, val, err => {
            if (err) console.error(err);
          });
        });
        Homey.alert('Settings saved');
      });
      Homey.ready();
    }
  </script>
</body>
</html>
